library(stars)
filespaths <- dir(
  "data/data-format/bird-transformed", 
  recursive = TRUE, 
  full.names = TRUE
)

# Create folders to export to 
output <- "data/data-format/bird-vulnerability/"
folders <- dir("data/data-format/bird-transformed")

for(i in 1:length(folders)) dir.create(paste0(output, folders[i]), recursive = TRUE)

# Selecting most updated stressors
stressor_names <- c(
  "Built2009", "croplands2005", "2013-inorganic", "2013-invasives","2013-night_lights", "2013-ocean_pollution", "2013-plumes_fert",
  "2013-plumes_pest", "2013-population", "2013-shipping","Lights2009","NavWater2009","Pasture2009","Popdensity2010", "Railways", "Roads")

vmatrix <- vroom::vroom("data/data-format/v-matrix.csv")
stopifnot(all(stressor_names %in% colnames(vmatrix)[-1]))
vmatrix <- vmatrix[,c("Birds",stressor_names)]
bird <- gsub(" ", "_", vmatrix$Birds)
stopifnot(all(folders %in% bird))
vmatrix <- as.matrix(vmatrix[,-1])
rownames(vmatrix) <- bird

for(i in 1:length(stressor_names)) {
  # Get filepaths for stressor i
  uid <- stringr::str_detect(filespaths, stressor_names[i]) 
  files <- filespaths[uid] 
  
  # Load tif files for stressor i
  stress <- lapply(files, stars::read_stars) 
  
  # Evaluate vulnerability and export 
  newfiles <- gsub("bird-transformed","bird-vulnerability", files)
  for(j in 1:length(stress)) {
    # Vulnerability
    stress[[j]] <-stress[[j]] * vmatrix[folders[j],stressor_names[i]] 
    # Export
    stars::write_stars(
      stress[[j]],
      newfiles[j]
    )
  }
}

test <- stars::read_stars("data/data-format/bird-vulnerability/American_Golden-Plover/bird-vulnerability_American_Golden-Plover-halpern_cea-4f84f0e3-2013-population.tif")
image(test)
plot(test, breaks = "equal")
